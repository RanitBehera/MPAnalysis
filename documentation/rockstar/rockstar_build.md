# Rockstar - Build
We install the following two softwares and make a test run.
- rocckstar
- rockstar-galaxies

## Install libraries
For building we need following libraries.
### 1. gss-api (krb5)

Get the libraries from the link at https://packages.ubuntu.com/jammy/libkrb5-dev and download using `wget`. Extract using `tar`. Navigate inside and run `configure` to produce Makefile. Then run `make` on the generated Makefile to build the library.

Note that `make install` will install(copy) the build output of make in the location given previously in `--prefix` argument of `configure` command when generating Makefile. 
```
wget http://archive.ubuntu.com/ubuntu/pool/main/k/krb5/krb5_1.19.2.orig.tar.gz
tar -xvf krb5_1.19.2.orig.tar.gz
cd ./krb5-1.19.2/src/
./configure --prefix=/home/username/.local
make
make install
```
- Find "`gssapi/gssapi.h`" inside "`krb5-1.19.2/src/include/gssapi`".
- Find libraries inside "`krb5-1.19.2/src/lib`".


### 2. tirpc
Download it from the link https://sourceforge.net/projects/libtirpc/ with `wget`. Extract using `tar`. Navigate inside and run `configure` to produce Makefile. Then run `make` on the generated Makefile to build the library.

If "`gssapi/gssapi.h`" not found during this then install gssapi first (maybe in "`~/.local`"). If its still not found provide `CPPFLAGS` and `LDFLAGS`.
```
wget https://sourceforge.net/projects/libtirpc/files/libtirpc/1.3.4/libtirpc-1.3.4.tar.bz2
tar -xvf libtirpc-1.3.4.tar.bz2
./configure CPPFLAGS=-I/Data/home/ranit/.local/include LDFLAGS=-L/Data/home/ranit/.local/lib --prefix=/Data/home/ranit/.local/
make
make install
 ```
- Find header files in "`libtirpc-1.3.4/tirpc`".
- Find libraries in  "`libtirpc-1.3.4/src/.libs`".

### 3. hdf5
If avaiable in modolue load using 
```
module load cmake-3.27.4
```
First install `Cmake` which is neeeded to generate Makefile for hdf5 build.
Download it from link https://github.com/Kitware/CMake/releases/download/v3.28.0-rc5/cmake-3.28.0-rc5.tar.gz using wget.

```
wget https://github.com/Kitware/CMake/releases/download/v3.28.0-rc5/cmake-3.28.0-rc5.tar.gz
tar -xzvf cmake-3.28.0-rc5.tar.gz
cd cmake-3.28.0-rc5/

```

Then

Download it from link https://www.hdfgroup.org/downloads/hdf5/source-code/. It does not provide `wget` link. So you can download locally and upload using `scp`. So in hdf

```
module load cmake-3.27.4
cd hdf5-1.14.3
mkdir build
cmake -S ./ -B ./build
cd ./build
make
```
- Find headers `hdf5.h` in `hdf5-1.14.3/src`
- Find headers `H5pubconf.h` in `hdf5-1.14.3/build/src`
- Find headers `H5FDsubfiling.h` in `hdf5-1.14.3/src/H5FDsubfiling`
- Find lib `libhdf5.so` in `hdf5-1.14.3/build/bin`

## Download
Repository address
- **rockstar** : <br>
  https://www.peterbehroozi.com/code.html <br> 
  https://bitbucket.org/gfcstanford/rockstar/src/main/
- **rockstar-galaxies** : <br>
  https://bitbucket.org/pbehroozi/rockstar-galaxies/src/main/

Use the "Clone" button and copy the link. Mke sure its HTTPS link and not SSH link. Then run it on terminal to clone.
- `git clone https://bitbucket.org/gfcstanford/rockstar.git`
- `git clone https://bitbucket.org/pbehroozi/rockstar-galaxies.git`

## Makefile strcuture

|Flag||Used To|
|-|:-:|-|
|
||**CFLAGS**|
|-m64 |:|generate code for a 64-bit environment
|-D_LARGEFILE_SOURCE |:|enable large file support
|-D_LARGEFILE64_SOURCE |:|enable large file support
|-D_FILE_OFFSET_BITS=64|:|enable large file support
|-D_BSD_SOURCE |:| enable BSD feature macros that are not defined by default
|-D_POSIX_SOURCE |:|
|-D_POSIX_C_SOURCE=200809L |:|
|-D_SVID_SOURCE |:|
|-D_DARWIN_C_SOURCE |:|
|-Wall |:|enable all warnings
|-fno-math-errno |:|optimize all math functions as if they do not set "errno"<br>at the cost of making error detection harder<br> might also disable errno for non-math functions such as malloc
|-fPIC|:| generate position-independent code
||**LDFLAGS**|
|-shared |:| create a shared object file instead of an executable file which can then be linked with other programs using the -l flag
||**OFLAGS**|
|-lm |:| `-l` for linking  to `libm` library for math.h which is not a standard library
|-O3 |:|Aggressive optimisation of -O2 plus some extra optimsation which doesnot guarantee to increase performance 
|-std=c99 |:|Use C99 standard for compilation
|-rdynamic |:|adds all symbols, not only used ones, to the dynamic symbol table
|-g |:|include debugging information in the executable file generated by the compiler which can be used by `gdb` debugger
||**DEBUGFLAGS**| 
|-O0 |:|disables all optimisation. Useful while debuging due to easy code readability.
||**PROFFLAGS**|
|-pg |:|
|-O2 |:|Agressive optimisation
||**CC**| 
|gcc|:|the compiller
||**CFILES**|
List of all source files its compiling except "main.c" which is included directly
||**DIST_FLAGS**|
||**HDF5_FLAGS**|
|-DH5_USE_16_API |:|
|-lhdf5 -DENABLE_HDF5 |:|
|-I/opt/local/include |:|
|-L/opt/local/lib |:|

In Makefile the default target `all` executing<br>
`@make reg EXTRA_FLAGS="$(OFLAGS)"`<br>
So it calls the `reg` target which execute<br> 
`$(CC) $(CFLAGS) main.c $(CFILES) -o rockstar  $(EXTRA_FLAGS)`



## Add Paths
If you just go inside the `rockstar` folder and run `make` you would probably see compiler errors and linker error (ld error). To give proper paths do the followings.

To include header add path to environment variable PATH. To add path for linker add the path of `libtirpc.a` in `OFLAGS`.

So change<br>
`OFLAGS = -lm -O3 -std=c99 -rdynamic -g`<br>
to<br>
`OFLAGS = -lm -O3 -std=c99 -rdynamic -g -L/usr/lib/ -ltirpc`<br>
if<br>
`libtirpc.a` is in "`/usr/lib/`".<br>
Change the path appropiately depending on installed location.

## Build
Now run `make` to build which outputs `rockstar` executable.

Tip - 1 : (Run from anywhere)<br>
Create a soft-link to this in a path where terminal can find it via PATH environment variables like `/home/user/.local/bin`. You can then run it from anywhere in the system. So use<br>
`ln -s /home/user/rockstar/rockstar /home/user/.local/bin`.

Tip - 2 : (Clear deprecation warnings)<br>
If you get bunch of message like <br>
"warning: #warning "_BSD_SOURCE and _SVID_SOURCE are deprecated, use _DEFAULT_SOURCE"<br>
do change it in Makefile. So from `CFLAGS` remove `-D_BSD_SOURCE` and `-D_SVID_SOURCE` and add `-D_DEFAULT_SOURCE`. This will clean build process warnings in terminal.

Tip - 3 : (Add HDF5 support)<br>
If you want hdf5 support add the path to library in `HDF5_FLAGS`. So change<br>
`HDF5_FLAGS = -DH5_USE_16_API -lhdf5 -DENABLE_HDF5 -I/opt/local/include -L/opt/local/lib`<br>
to<br>
`HDF5_FLAGS = -DH5_USE_16_API -lhdf5 -DENABLE_HDF5 -I/opt/local/include -L/opt/local/lib -I/usr/include/hdf5/serial/ -L/usr/lib/x86_64-linux-gnu/hdf5/serial/ -lhdf5`

Tip - 4 : (Error in "rockstar-galaxies")<br>
For `rockstar-galaxies` do the same. Add the paths for `tirpc` and `hdf5` with removing deprecated stuff and then run `make`.
You may see the error "multiple definition of `final_bg` and `p_bounds`". Add the `-rdynamic` and `-g` in `OFLAGS` for better error message where exactly its getting multipl defined. It turns out that the issue is in two files `interleaving.h` and `fun_times.h`. To fix this add `extern` in variable declaration, as follows.

- Open `interleaving.h` file. Change the declaration `struct bgroup *final_bg;` to `extern struct bgroup *final_bg;` (in Line 21). Save it.
- Open `fun_times.h` file. Change the declaration `struct prev_bounds *p_bounds;` to `extern struct prev_bounds *p_bounds;` (in Line 18). Save it.

This may get fixed in original repoin future. 