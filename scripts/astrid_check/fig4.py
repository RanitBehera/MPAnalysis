import galspec
import matplotlib.pyplot as plt
import numpy as np


BOX = galspec.NavigationRoot("/mnt/home/student/cranit/Work/RSGBank/OUT_L50N640")
LBOX = galspec.NavigationRoot("/mnt/home/student/cranit/Work/RSGBank/L50N640")

h=0.697

BOXSIZE = 50/h
VOLUME = BOXSIZE**3



z_to_snap = {
            12:16,
            11:20,
            10:24,
            9:30,
            8:36,
            # 7:42,
            # 6:50,
            # 5:60,
            # 4:71
            }


z=list(z_to_snap.keys())
sfrd=[]
sfrd_masked_rks=[]
sfrd_masked_fof=[]

for zi in z:
    print(zi,flush=True)
    snap = z_to_snap[zi]

    gas_sfrs = LBOX.PART(snap).Gas.StarFormationRate()   # Mo/yr      #<----h??
    box_sfrd = np.sum(gas_sfrs)/VOLUME
    sfrd.append(box_sfrd)


    halo_sfr = BOX.RSG(snap).RKSGroups.StarFormationRate()    # Mo/yr
    mask = halo_sfr>0.3
    box_sfrd_masked = sum(halo_sfr*mask)/VOLUME
    sfrd_masked_rks.append(box_sfrd_masked)

    halo_sfr = LBOX.PIG(snap).FOFGroups.StarFormationRate()    # Mo/yr
    mask = halo_sfr>0.3
    box_sfrd_masked = sum(halo_sfr*mask)/VOLUME
    sfrd_masked_fof.append(box_sfrd_masked)


    
plt.plot(z,np.log10(sfrd),label="NINJA - Full")
plt.plot(z,np.log10(sfrd_masked_rks),'--',label="NINJA - $SFR>0.3M_\odot/yr (RKS)$")
plt.plot(z,np.log10(sfrd_masked_fof),'--',label="NINJA - $SFR>0.3M_\odot/yr (FOF)$")



# Digitised Plot - Astrid Figure 4
# Astrid entrie box 
x = [11.98876404494382, 11.96629213483146, 11.662921348314606, 11.617977528089888, 11.584269662921347, 11.303370786516854, 11.022471910112358, 10.775280898876403, 10.52808988764045, 10.146067415730336, 9.921348314606742, 9.685393258426966, 9.292134831460675, 9.022471910112358, 8.404494382022472, 8.078651685393258, 7.52808988764045, 7.213483146067416, 6.51685393258427, 6.033707865168539, 5.764044943820225, 5.629213483146067, 5.52808988764045, 5.460674157303371, 5.370786516853933, 5.269662921348314, 5.235955056179775, 5.033707865168539, 4.943820224719101, 4.820224719101123, 4.719101123595506, 4.393258426966292, 4.269662921348314, 4.179775280898877, 4.056179775280899, 3.955056179775281, 3.797752808988764, 3.629213483146067, 3.460674157303371, 3.3146067415730336, 3.168539325842697, 3.01123595505618, 2.9775280898876404, 2.8876404494382024, 2.8202247191011236, 2.8876404494382024]
y = [-3.8215613382899627, -3.721189591078067, -3.5985130111524164, -3.6654275092936803, -3.5817843866171004, -3.470260223048327, -3.3754646840148697, -3.2973977695167287, -3.2249070631970262, -3.096654275092937, -3.0185873605947955, -2.9516728624535316, -2.8234200743494426, -2.7342007434944238, -2.550185873605948, -2.449814126394052, -2.288104089219331, -2.1877323420074353, -1.970260223048327, -1.8197026022304832, -1.7527881040892193, -1.7193308550185873, -1.6747211895910783, -1.6301115241635689, -1.6189591078066914, -1.546468401486989, -1.5743494423791824, -1.4014869888475836, -1.4516728624535316, -1.4237918215613385, -1.4349442379182156, -1.3457249070631971, -1.3289962825278812, -1.3289962825278812, -1.2843866171003717, -1.2788104089219332, -1.2286245353159853, -1.2007434944237918, -1.1951672862453533, -1.1394052044609668, -1.1282527881040894, -1.066914498141264, -1.1059479553903349, -1.055762081784387, -1.022304832713755, -1.055762081784387]
plt.plot(x,y,label="Astrid - Full")
# Astrid SFR>0.3M0/yr
x = [12, 10.325842696629213, 8.730337078651687, 7.258426966292134, 5.955056179775281, 4.955056179775281, 4.550561797752809, 4.247191011235955, 3.8764044943820224, 3.696629213483146, 3.4269662921348316, 3.3146067415730336, 3.202247191011236, 3.0786516853932584, 3]
y = [-4.5241635687732344, -3.7267657992565058, -3.0353159851301115, -2.433085501858736, -1.908921933085502, -1.4851301115241635, -1.479553903345725, -1.3736059479553906, -1.3122676579925652, -1.2676579925650557, -1.2397769516728627, -1.1728624535315988, -1.1895910780669148, -1.1226765799256508, -1.1505576208178439]
plt.plot(x,y,'--',label="Astrid - $SFR>0.3M_\odot/yr")
# Astrid Observed Points
x = [10.213483146067414, 9.01123595505618, 7.921348314606742, 6.820224719101123, 5.910112359550562, 4.910112359550562, 3.808988764044944, 3.01123595505618]
y = [-3.2862453531598512, -3.1356877323420074, -2.193308550185874, -1.892193308550186, -1.7304832713754648, -1.4516728624535316, -1.2397769516728627, -1.005576208178439]

yerr = np.array([(0.15,0.15),(0.2,0.2),(0.07,0.07),(0.06,0.06),(0.12,0.12),(0.10,0.10),(0.12,0.12),(0.07,0.07)]).T
xerr = np.array([(0.5,0.5),(0.5,0.5),(0.5,0.5),(0.5,0.5),(0.5,0.5),(0.5,0.5),(0.5,0.5),(0.5,0.5)]).T

# # plt.errorbar(x,y,'.',yerr=yerr,xerr=xerr,ms=20)
plt.errorbar(x,y,yerr,xerr,fmt='.',ms=10)

plt.legend()

plt.xlabel("$z$")
plt.ylabel("$\log_{10}$ SFRD ($M_\odot$ yr$^{-1}$ Mpc$^{-3}$)")

plt.show()